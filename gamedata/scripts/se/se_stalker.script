-- -*- mode: lua; coding: windows-1251-dos -*-

--Ð Ð°ÑÑÑ‚Ð¾ÑÐ½Ð¸Ðµ, Ñ ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ð³Ð¾ Ð½Ð°Ð¿Ð°Ñ€Ð½Ð¸ÐºÐ¸ Ð±ÑƒÐ´ÑƒÑ‚ Ñ‚ÐµÐ»ÐµÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒÑÑ Ðº Ð°ÐºÑ‚Ð¾Ñ€Ñƒ.
local COMPANION_SWITCH_DISTANCE = 100


class "se_stalker"	(cse_alife_human_stalker)
function se_stalker:__init (section) super (section)
	self.ini = nil
	self.ini_initialized = false

	self.spawner_present = false

	self.smart_terrain_conditions = nil

	-- ÑÑ‚Ð¾Ñ‚ Ñ„Ð»Ð°Ð³ Ð±ÐµÑ€Ñ‘Ñ‚ÑÑ Ð¸Ð· Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ ÑÐ¼Ð°Ñ€Ñ‚Ð°
	-- true     = Ð²ÑÐµÐ³Ð´Ð° Ð² Ð¾Ð½Ð»Ð°Ð¹Ð½Ðµ
	-- false    = Ð²ÑÐµÐ³Ð´Ð° Ð² Ð¾Ñ„Ð»Ð°Ð¹Ð½Ðµ
	-- condlist = ÑƒÑÐ»Ð¾Ð²Ð¸Ðµ, ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ðµ Ð¾Ñ‚Ð¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÑ‚ true Ð¸Ð»Ð¸ false
	-- nil      = ÑÐ¼Ð°Ñ€Ñ‚Ñƒ Ð²ÑÑ‘ Ñ€Ð°Ð²Ð½Ð¾
	self.job_online          = nil
	self.job_online_condlist = nil

	-- Ð¿Ð¾ÑÐµÑ‰Ð°Ð» Ð»Ð¸ ÑÑ‚Ð°Ð»ÐºÐµÑ€ Ñ…Ð¾Ñ‚ÑŒ Ð¾Ð´Ð¸Ð½ smart_terrain
	self.was_in_smart_terrain = false --TODO: Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ñ ÐÐ˜. ÐÐµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð½Ð¸Ð³Ð´Ðµ.

	self.death_dropped = false --Ð“ÐµÐ½ÐµÑ€Ð¸Ð» Ð»Ð¸ Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð¶ Ð²Ñ‹Ð¿Ð°Ð´Ð°ÐµÐ¼Ñ‹Ðµ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ñ‹ Ð¸Ð»Ð¸ Ð½ÐµÑ‚.
	self.treasure_processed = false --ÐžÐ±Ñ‹ÑÐºÐ¸Ð²Ð°Ð»ÑÑ Ð»Ð¸ Ñ‚Ñ€ÑƒÐ¿ Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð¶Ð° Ð°ÐºÑ‚Ð¾Ñ€Ð¾Ð¼

	--' Ð¤Ð»Ð°Ð³ ÑÐ¼ÐµÑ€Ñ‚Ð¸ Ð² Ð¾Ñ„Ñ„Ð»Ð°Ð¹Ð½Ðµ
	self.offline_dead = 0

	--' Ð¥Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…
	self.s_storage = "_"
end
--------------------
function se_stalker:get_ini()
	if not self.ini_initialized then
		self.ini             = self:spawn_ini ()
		self.ini_initialized = true

		if self.ini:section_exist("spawner") then
			self.spawner = xr_logic.parse_condlist(db.actor, "spawner", "cond", self.ini:r_string("spawner", "cond"))
		end
	end
end
--------------------
function se_stalker:get_job_online()
	if self.job_online_condlist == nil then
		return self.job_online
	else
		return xr_logic.pick_section_from_condlist(db.actor_proxy, self, self.job_online) ~= nil
	end
end
--------------------
function se_stalker:can_switch_offline()
	local can_be_offline = false
	if self.force_offline then
		can_be_offline = true
	else	
		if self:get_job_online() ~= nil then
			can_be_offline = not self:get_job_online()
		else
			can_be_offline = cse_alife_human_stalker.can_switch_offline(self)
		end
	end
	--
	if xr_companion.is_companion(self.id) and not self.force_offline and db.actor_proxy.online then
		return db.actor:position():distance_to(self.position) > COMPANION_SWITCH_DISTANCE
	end
	--
	return can_be_offline
end
--------------------
function se_stalker:can_switch_online()
	if self.force_offline then
		return false
	end
	if xr_companion.is_companion(self.id) and (db.actor_proxy.online and db.actor:position():distance_to(self.position) < COMPANION_SWITCH_DISTANCE) then
		return true
	end		

	if self:get_job_online() ~= nil then
		return self:get_job_online()
	end

	if self.ini == nil or self.spawner == nil then
		return cse_alife_human_stalker.can_switch_online(self)
	end
    
	if db.actor_proxy.online and not db.actor:alive() then --?
		return self.online
	end
    
	if self.online == false then
	    return (xr_logic.pick_section_from_condlist(db.actor_proxy, self, self.spawner) ~= nil) and cse_alife_human_stalker.can_switch_online(self)
    else
        return xr_logic.pick_section_from_condlist(db.actor_proxy, self, self.spawner) ~= nil
    end    	    
end
--------------------
function se_stalker:STATE_Write (packet)
	cse_alife_human_stalker.STATE_Write (self, packet)

	if self.job_online == true then
		packet:w_u8(0)
	elseif self.job_online == false then
		packet:w_u8(1)
	elseif self.job_online == nil then
		packet:w_u8(2)
	else
		packet:w_u8(3)
		packet:w_stringZ(self.job_online_condlist)
	end

	packet:w_bool(self.was_in_smart_terrain)

	local flags = 0
	if self.death_dropped then flags = bit_or(flags, 1) end
	if self.treasure_processed then flags = bit_or(flags, 2) end
	packet:w_u8(flags)

	--KRodin: Ð²Ð¾Ñ‚ ÑÑ‚Ð¾ Ð²Ð°Ð¶Ð½Ð¾Ðµ ÑƒÑÐ»Ð¾Ð²Ð¸Ðµ! Ð•ÑÐ»Ð¸ ÐµÐ³Ð¾ ÑƒÐ±Ñ€Ð°Ñ‚ÑŒ, Ð½Ðµ ÑÐ¿Ð°Ð²Ð½ÑÑ‚ÑÑ Ð½ÐµÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð²ÐµÑ‡Ð½Ñ‹Ðµ Ñ‚Ñ€ÑƒÐ¿Ñ‹, Ð² Ñ‚.Ñ‡. ÐºÐ²ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ, Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€ Ñ‚Ñ€ÑƒÐ¿ ÐŸÑ€Ð¸Ð·Ñ€Ð°ÐºÐ° Ð² X-16
	if self.id ~= 65535 then
		--log3("~~[se_stalker:STATE_Write] id of [%s] is [%s]", self:name(), self.id)
		packet:w_u32(self.offline_dead)
		packet:w_stringZ(self.s_storage) -- Ð´Ð¾Ð¿Ð¸ÑˆÐµÐ¼ ÐµÐ³Ð¾ Ðº Ð¿Ð°ÐºÐµÑ‚Ñƒ
	else
		--log3("~~[se_stalker:STATE_Write] id of [%s] is [%s]", self:name(), self.id)
	end
end
--------------------

function se_stalker:STATE_Read (packet, size)
	cse_alife_human_stalker.STATE_Read (self, packet, size)

	local t = packet:r_u8()

	if t == 0 then
		self.job_online = true
	elseif t == 1 then
		self.job_online = false
	elseif t == 2 then
		self.job_online = nil
	else
		self.job_online_condlist = packet:r_stringZ()
		self.job_online = xr_logic.parse_condlist(nil, "se_stalker:STATE_Read", "job_online", self.job_online_condlist)
	end

	self.was_in_smart_terrain = packet:r_bool()

	local flags = packet:r_u8()
	self.death_dropped = bit_and(flags, 1) ~= 0
	self.treasure_processed = bit_and(flags, 2) ~= 0

	--KRodin: Ð²Ð¾Ñ‚ ÑÑ‚Ð¾ Ð²Ð°Ð¶Ð½Ð¾Ðµ ÑƒÑÐ»Ð¾Ð²Ð¸Ðµ! Ð•ÑÐ»Ð¸ ÐµÐ³Ð¾ ÑƒÐ±Ñ€Ð°Ñ‚ÑŒ, Ð½Ðµ ÑÐ¿Ð°Ð²Ð½ÑÑ‚ÑÑ Ð½ÐµÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð²ÐµÑ‡Ð½Ñ‹Ðµ Ñ‚Ñ€ÑƒÐ¿Ñ‹, Ð² Ñ‚.Ñ‡. ÐºÐ²ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ, Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€ Ñ‚Ñ€ÑƒÐ¿ ÐŸÑ€Ð¸Ð·Ñ€Ð°ÐºÐ° Ð² X-16
	if self.id ~= 65535 then
		--log3("~~[se_stalker:STATE_Read] id of [%s] is [%s]", self:name(), self.id)
		self.offline_dead = packet:r_u32()
		self.s_storage = packet:r_stringZ() -- ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ, Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ð¼ Ð¸Ð· ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½Ð½Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐ¸
	else
		--log3("~~[se_stalker:STATE_Read] id of [%s] is [%s]", self:name(), self.id)
	end
end
--------------------
function se_stalker:on_before_register()
	local strn_id = self:smart_terrain_id()
	if strn_id ~= 65535 then
		ASSERT(
			alife():object( strn_id ),
			"[%s]: %s: wrong smart_terrain_id(): %s",
			script_name(), self:name(), strn_id
		)
	end
	--
	ogse_signals.get_mgr():call( "se_stalker_on_before_register", self )
	self:fill_exclusives()
	xr_companion.is_companion_se(self)
	if not self.has_none_true then
		self.has_none_true = not self:alive() or xr_companion.is_companion(self.id)
	end
	if self.has_none_true then
		self:brain():can_choose_alife_tasks( false )
	end
end
--------------------
local forbidden_comms = {
	["zombied"] = true,
	["monolith"] = true,
	["arena_enemy"] = true
}
function se_stalker:on_register()
	local trader = self:get_trader()
	self._charname = trader.character_name -- Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð¼Ñ Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð¶Ð° Ð´Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ð² Ð´Ð°Ð»ÑŒÐ½ÐµÐ¹ÑˆÐµÐ¼
	--
	alife():remove_in_restrictions( self )
	--
	cse_alife_human_stalker.on_register( self )

	if not forbidden_comms[self:community()] then
		actor_stats.add_to_ranking(self.id)
	end

	--' Ðåãèñòðàöèÿ â òàñêìåíåäæåðå
	task_manager.get_random_task():register_target(self)
	
	if not self.has_none_true and self:smart_terrain_id() == 65535 then
		self:brain():update()
	end

	alife():set_interactive( self, true )
end
function se_stalker:character_name()
	return self._charname -- Ð½Ðµ Ð¼ÐµÐ½ÑÐµÑ‚ÑÑ
end

--------------------
function se_stalker:on_unregister()
	cse_alife_human_stalker.on_unregister(self)

	smart_terrain.unregister_npc(self)

	--' Îòðåãèñòðàöèÿ â òàñêìåíåäæåðå
	task_manager.get_random_task():unregister_target(self)
	
	if not forbidden_comms[self:community()] then
		actor_stats.remove_from_ranking(self.id)
	end
end
--------------------
function se_stalker:on_death(killer)
	cse_alife_human_stalker.on_death(self, killer)

	-- Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð¼ÐµÑ‚Ð¾Ðº Ñ ÐºÐ²ÐµÑÑ‚Ð¾Ð²Ñ‹Ñ… Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð¶ÐµÐ¹
	if level.map_has_object_spot(self.id, "green_location") ~= 0 then
		level_tasks.remove_location_by_id(self.id, "green_location") 
	end

	-- Ð¿Ð¾Ñ‡Ð¸ÑÑ‚Ð¸Ð¼ Ð¾Ñ‚Ð½Ð¾ÑˆÐµÐ½Ð¸Ñ
	ogse_signals.get_mgr():call("on_release_npc", self.id)
end
--------------------
function se_stalker:fill_exclusives()
	self:get_ini()
	self.smart_terrain_conditions, self.has_none_true = smart_terrain.read_smart_terrain_conditions( self )

	if self.smart_terrain_conditions then
		for name, condlist in pairs(self.smart_terrain_conditions) do
			smart_terrain.exclusives[name] = (smart_terrain.exclusives[name] or 0) + 1
		end
	end
end

-- Dsh (c):
-- Ð­Ñ‚Ð¾ Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ‚ÑŒ Ð½Ðµ Ð½ÑƒÐ¶Ð½Ð¾, Ð±ÑƒÐ´ÑƒÑ‚ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹. ÐÐ¸ Ð´Ð²Ð¸Ð¶Ð¾Ðº, Ð½Ð¸ ÑÐºÑ€Ð¸Ð¿Ñ‚Ñ‹ Ð½Ð° ÑÑ‚Ð¾
-- Ð½Ðµ Ñ€Ð°ÑÑ‡Ð¸Ñ‚Ð°Ð½Ñ‹. ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð° Ð² Ñ‚Ð¾Ð¼, Ñ‡Ñ‚Ð¾ Ð¾Ð½Ð¾ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
-- ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÑŽÑ‚ÑÑ. ÐŸÑ€Ð¸ Ñ‚Ð¾Ð¼, Ð²ÑÐµ Ð´Ð°Ð½Ð½Ñ‹Ðµ, Ð½Ðµ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‚Ð¾, Ñ‡Ñ‚Ð¾ ÑÐºÑ€Ð¸Ð¿Ñ‚Ñ‹
-- Ð·Ð°Ð¿Ð¸ÑˆÑƒÑ‚, Ð½Ð¾ Ð¸ Ñ‚Ð¾, Ñ‡Ñ‚Ð¾ Ð´Ð²Ð¸Ð¶Ð¾Ðº ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÑ‚. Ð’ ÑÑ‚Ð¾Ð¼-Ñ‚Ð¾ Ð¸
-- Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð°. ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð´Ð²Ð¸Ð¶Ð¾Ðº ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÑ‚ÑÑ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ best_danger Ð¸
-- Ð²Ð¾Ñ‚ Ñ‡Ñ‚Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÑ‚ÑÑ. ÐÐ° Ð¯Ð½Ñ‚Ð°Ñ€Ðµ Ñƒ Ð´Ð¾Ð»Ð³Ð¾Ð²Ñ†Ð° Ð±Ñ‹Ð» best_danger, Ð½Ñƒ Ð¿ÑƒÑÑ‚ÑŒ
-- Ð´Ñ€ÑƒÐ³Ð¾Ð¹ Ð´Ð¾Ð»Ð³Ð¾Ð²ÐµÑ†. Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð¼Ñ‹ ÑƒÑ…Ð¾Ð´Ð¸Ð¼ Ñ Ð»Ð¾ÐºÐ°Ñ†Ð¸Ð¸ Ð¸ best_danger Ð¾ÑÑ‚Ð°ÐµÑ‚ÑÑ
-- Ð² ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¸Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…. Ð§ÐµÑ€ÐµÐ· Ð½ÐµÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ ÑÑ‚Ð¾Ñ‚ Ð´Ð¾Ð»Ð³Ð¾Ð²ÐµÑ† Ñ‚Ð¾Ð¶Ðµ
-- ÑƒÑ…Ð¾Ð´Ð¸Ñ‚ Ñ Ð¯Ð½Ñ‚Ð°Ñ€Ðµ Ð¸ Ð¼Ñ‹ Ñ Ð½Ð¸Ð¼ Ð¿ÐµÑ€ÐµÑÐµÐºÐ°ÐµÐ¼ÑÑ Ð² Ð‘Ð°Ñ€Ðµ. Ð˜ Ñ‡Ñ‚Ð¾ Ð¼Ñ‹ Ð²Ð¸Ð´Ð¸Ð¼?
-- Ð”Ð¾Ð»Ð³Ð¾Ð²ÐµÑ† Ð² Ð¸ÑÑ‚ÐµÑ€Ð¸ÐºÐµ, Ñ‚.Ðº. Ñƒ Ð½ÐµÐ³Ð¾ ÐµÑÑ‚ÑŒ best_danger, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð±Ñ‹Ð»
-- Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½ Ð¸Ð· ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¸Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…, Ñ‚.Ðº. Ð¾Ð½Ð¸ Ð½Ðµ Ð±Ñ‹Ð»Ð¸ Ð¾Ñ‡Ð¸Ñ‰ÐµÐ½Ñ‹ Ð¸Ð·-Ð·Ð°
-- keep_saved_data_anyway(). Ð¢Ð¾Ð¶Ðµ ÑÐ°Ð¼Ð¾Ðµ Ñ Ñ…Ð¸Ñ‚Ð¾Ð²Ð¾Ð¹ Ð¿Ð°Ð¼ÑÑ‚ÑŒÑŽ. ÐÐ° Ð´Ñ€ÑƒÐ³Ð¾Ð¹
-- Ð»Ð¾ÐºÐ°Ñ†Ð¸Ð¸ Ñƒ Ð½ÐµÐ¿Ð¸ÑÑ Ð²ÑÐ¿Ð»Ñ‹Ð²Ð°ÐµÑ‚ Ñ…Ð¸Ñ‚, m_object ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ð³Ð¾ Ð½ÐµÑ‚, Ñ‚.Ðº. Ð¾Ð½
-- Ð¾ÑÑ‚Ð°Ð»ÑÑ Ð½Ð° Ñ‚Ð¾Ð¹ Ð»Ð¾ÐºÐ°Ñ†Ð¸Ð¸, Ð³Ð´Ðµ Ñ…Ð¸Ñ‚ Ð±Ñ‹Ð» Ð½Ð°Ð½ÐµÑÐµÐ½.
--
-- Ð¡Ð¾ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð°Ð¼Ð¸ Ñ‚Ð¾Ð¶Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð° Ð²ÑÐ¿Ð»Ñ‹Ð²Ð°ÐµÑ‚. ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð²
-- xr_logic. ÐŸÑ€ÐµÐ´ÑÑ‚Ð°Ð²Ð¸Ð¼, Ñ‡Ñ‚Ð¾ Ð½ÐµÐ¿Ð¸ÑÑŒ Ð±Ñ‹Ð» Ð² ÑÐ¼Ð°Ñ€Ñ‚Ðµ, Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð» Ñ‚Ð°Ð¼ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ð¸
-- Ñƒ Ð½ÐµÐ³Ð¾ Ð±Ñ‹Ð»Ð° Ð°ÐºÑ‚Ð¸Ð²Ð½Ð°Ñ Ð»Ð¾Ð³Ð¸ÐºÐ°. ÐœÑ‹ ÑƒÑˆÐ»Ð¸ Ñ Ð»Ð¾ÐºÐ°Ñ†Ð¸Ð¸ Ð¸ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð°Ñ Ð»Ð¾Ð³Ð¸ÐºÐ°
-- Ð±Ñ‹Ð»Ð° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð° Ð² ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¸Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…. ÐŸÐ¾Ñ‚Ð¾Ð¼ Ð½ÐµÐ¿Ð¸ÑÑ Ð²Ñ‹Ð³Ð½Ð°Ð»Ð¸ Ð¸Ð· ÑÐ¼Ð°Ñ€Ñ‚Ð°
-- Ð¸ ÐµÐ³Ð¾ Ð¿Ñ€Ð¸Ð½ÑÐ»Ð¸ Ð² Ð´Ñ€ÑƒÐ³Ð¾Ð¹. Ð’ÑÐµ ÑÑ‚Ð¾ Ð±Ñ‹Ð»Ð¾ Ð² Ð¾Ñ„Ñ„Ð»Ð°Ð¹Ð½Ðµ Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
-- Ð²ÑÐµ ÐµÑ‰Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ Ð°ÐºÑ‚Ð¸Ð²Ð½ÑƒÑŽ Ð»Ð¾Ð³Ð¸ÐºÑƒ Ð¿ÐµÑ€Ð²Ð¾Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑÐ¼Ð°Ñ€Ñ‚Ð°. Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð¼Ñ‹
-- Ð¿ÐµÑ€ÐµÑÐµÐºÐ°ÐµÐ¼ÑÑ Ñ Ð½Ð¸Ð¼ Ð½Ð° ÐºÐ°ÐºÐ¾Ð¹-Ð½Ð¸Ð±ÑƒÐ´ÑŒ Ð»Ð¾ÐºÐ°Ñ†Ð¸Ð¸ Ð¸ Ñ‚ÑƒÑ‚ xr_logic
-- Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ ÐµÐ³Ð¾ Ð°ÐºÑ‚Ð¸Ð²Ð½ÑƒÑŽ Ð»Ð¾Ð³Ð¸ÐºÑƒ Ð¸ Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ, Ñ‡Ñ‚Ð¾ Ð½Ð¸ÐºÐ°ÐºÐ¾Ð¹
-- Ð²ÐµÑ€Ñ‚ÐµÐºÑ Ð¿ÑƒÑ‚Ð¸ ÑÑ‚Ð¾ Ð»Ð¾Ð³Ð¸ÐºÐ¸, Ð½Ð° ÑÑ‚Ð¾Ð¹ Ð»Ð¾ÐºÐ°Ñ†Ð¸Ð¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚. Ð”Ð²Ð¸Ð¶Ð¾Ðº
-- Ð¾Ð±Ð¸Ð¶Ð°ÐµÑ‚ÑÑ Ð¸ Ð¿Ð°Ð´Ð°ÐµÑ‚.
--
-- ÐŸÐµÑ€ÐµÐ´ÐµÐ»Ñ‹Ð²Ð°Ñ‚ÑŒ Ð²ÑÐµ ÑÑ‚Ð¾ Ñ Ð½Ðµ Ð²Ð¸Ð¶Ñƒ ÑÐ¼Ñ‹ÑÐ»Ð°. Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾Ð¹ Ð»Ð¾Ð³Ð¸ÐºÐ¸
-- ÑÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð²Ñ‹Ð¼Ð¸ Ð¼ÐµÑ‚Ð¾Ð´Ð°Ð¼Ð¸ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ Ð¼ÐµÐ½ÑŒÑˆÐ¸Ñ… ÑƒÑÐ¸Ð»Ð¸Ð¹, Ñ‡ÐµÐ¼ Ð¿Ñ€Ð¸Ð²ÐµÐ´ÐµÐ½Ð¸Ðµ Ð²ÑÐµÐ³Ð¾
-- ÑÑ‚Ð¾Ð³Ð¾ Ð² Ð¿Ð¾Ñ€ÑÐ´Ð¾Ðº.
--
-- function se_stalker:keep_saved_data_anyway()
--   return true
-- end


--'Ð¢Ð¾Ñ€Ð³Ð¾Ð²ÐµÑ†
class "se_trader" (cse_alife_trader)
function se_trader:__init (section) super (section)
  --' Ð¥Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…
  self.s_storage = "_"
end

function se_trader:STATE_Write( packet )
  cse_alife_trader.STATE_Write( self, packet )
  packet:w_stringZ( self.s_storage ) -- Ð´Ð¾Ð¿Ð¸ÑˆÐµÐ¼ ÐµÐ³Ð¾ Ðº Ð¿Ð°ÐºÐµÑ‚Ñƒ
end

function se_trader:STATE_Read( packet, size )
  cse_alife_trader.STATE_Read( self, packet, size )
  if not packet:r_eof() then
    -- ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ, Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ð¼ Ð¸Ð· ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½Ð½Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐ¸
    self.s_storage = packet:r_stringZ()
  end
end

function se_trader:keep_saved_data_anyway()
	return true
end
